<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Operario ‚Äì Workshop App</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #1a1a2e;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 28px 24px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
    }
    .step { display: none; }
    .step.active { display: block; }
    h2 { font-size: 22px; margin-bottom: 6px; color: #1a1a2e; }
    .sub { color: #6b7280; font-size: 14px; margin-bottom: 20px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #444; margin-bottom: 6px; margin-top: 14px; }
    input { width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; outline: none; }
    input:focus { border-color: #4f46e5; }
    .btn { width: 100%; padding: 16px; background: #4f46e5; color: white; border: none; border-radius: 12px; font-size: 17px; font-weight: 700; cursor: pointer; margin-top: 16px; }
    .btn:active { opacity: 0.85; }
    .btn-green { background: #25D366; }
    .btn-red { background: #dc2626; }
    .btn-gray { background: #6b7280; margin-top: 10px; }
    .info-box { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 10px; padding: 14px 16px; margin-bottom: 12px; }
    .info-box .lbl { font-size: 11px; color: #6b7280; font-weight: 700; text-transform: uppercase; }
    .info-box .val { font-size: 16px; font-weight: 700; color: #1e40af; margin-top: 3px; }
    .error { background: #fee2e2; color: #b91c1c; padding: 12px; border-radius: 8px; font-size: 14px; margin-top: 14px; }
    .whatsapp-note { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 10px; padding: 14px; font-size: 14px; color: #166534; margin-bottom: 16px; line-height: 1.5; }
    .success-icon { font-size: 72px; text-align: center; margin: 16px 0; }

    /* PANTALLA HORIZONTAL */
    .horizontal-screen {
      text-align: center;
      padding: 10px 0;
    }
    .phone-horizontal {
      display: inline-block;
      margin: 20px auto;
      position: relative;
    }
    .phone-body {
      width: 120px;
      height: 70px;
      border: 4px solid #1a1a2e;
      border-radius: 10px;
      background: #e0f2fe;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .phone-camera {
      width: 8px;
      height: 8px;
      background: #1a1a2e;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 6px;
      transform: translateY(-50%);
    }
    .phone-screen-icon {
      font-size: 28px;
    }
    .arrow-rotate {
      font-size: 40px;
      animation: rotate-hint 1.5s ease-in-out infinite;
      display: block;
      margin: 8px auto;
    }
    @keyframes rotate-hint {
      0% { transform: rotate(0deg); opacity: 1; }
      40% { transform: rotate(-90deg); opacity: 0.5; }
      100% { transform: rotate(0deg); opacity: 1; }
    }
    .horizontal-text {
      font-size: 18px;
      font-weight: 700;
      color: #1a1a2e;
      margin-top: 8px;
    }
    .horizontal-sub {
      font-size: 13px;
      color: #6b7280;
      margin-top: 6px;
      margin-bottom: 20px;
    }

    /* CONTADOR */
    .countdown-screen {
      text-align: center;
      padding: 20px 0;
    }
    .countdown-number {
      font-size: 120px;
      font-weight: 900;
      color: #4f46e5;
      line-height: 1;
      animation: pulse-num 1s ease-in-out;
    }
    @keyframes pulse-num {
      0% { transform: scale(1.4); opacity: 0; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .countdown-text {
      font-size: 16px;
      color: #6b7280;
      margin-top: 16px;
    }

    video { width: 100%; border-radius: 10px; background: #000; margin: 12px 0; max-height: 300px; }
  </style>
</head>
<body>
<div class="card">

  <!-- PASO 1: INFO FORMATO -->
  <div class="step active" id="step-info">
    <h2>üìã Trabajo</h2>
    <p class="sub">Informaci√≥n del formato escaneado</p>
    <div class="info-box">
      <div class="lbl">Proyecto</div>
      <div class="val" id="info-proyecto">Cargando...</div>
    </div>
    <div class="info-box">
      <div class="lbl">Formato</div>
      <div class="val" id="info-formato">Cargando...</div>
    </div>
    <button class="btn" onclick="irAHorizontal()">üé¨ Grabar v√≠deo</button>
    <div id="info-error"></div>
  </div>

  <!-- PASO 2: AVISO HORIZONTAL -->
  <div class="step" id="step-horizontal">
    <div class="horizontal-screen">
      <h2>üì± Gira el m√≥vil</h2>
      <p class="horizontal-sub">Para una mejor calidad, graba en horizontal</p>

      <div class="phone-horizontal">
        <div class="phone-body">
          <div class="phone-camera"></div>
          <span class="phone-screen-icon">üé¨</span>
        </div>
      </div>

      <span class="arrow-rotate">‚Ü∫</span>

      <div class="horizontal-text">Gira el m√≥vil as√≠ ‚Üî</div>
      <div class="horizontal-sub">Cuando est√©s listo pulsa el bot√≥n</div>
    </div>

    <button class="btn" onclick="iniciarCuentaAtras()">‚úÖ Listo, empezar</button>
    <button class="btn btn-gray" onclick="showStep('step-info')">Cancelar</button>
  </div>

  <!-- PASO 3: CUENTA ATR√ÅS -->
  <div class="step" id="step-countdown">
    <div class="countdown-screen">
      <div class="countdown-number" id="countdown-num">3</div>
      <div class="countdown-text">¬°Prep√°rate para grabar!</div>
    </div>
  </div>

  <!-- PASO 4: GRABANDO -->
  <div class="step" id="step-grabar">
    <h2 style="text-align:center; color:#dc2626">üî¥ Grabando...</h2>
    <p class="sub" style="text-align:center">Cuando termines pulsa Parar</p>
    <video id="video-live" autoplay muted playsinline></video>
    <button class="btn btn-red" onclick="pararGrabacion()">‚èπ Parar grabaci√≥n</button>
    <button class="btn btn-gray" onclick="cancelarGrabacion()">Cancelar</button>
  </div>

  <!-- PASO 5: CONFIRMAR -->
  <div class="step" id="step-confirmar">
    <h2>‚úÖ Confirmar</h2>
    <p class="sub">Revisa el v√≠deo y el t√≠tulo</p>
    <video id="video-replay" controls playsinline></video>
    <label>T√≠tulo del v√≠deo</label>
    <input id="titulo" type="text" />
    <div class="whatsapp-note">
      üì≤ Al pulsar <strong>"Enviar por WhatsApp"</strong>, el v√≠deo se descargar√° en tu m√≥vil. En WhatsApp adj√∫ntalo desde la galer√≠a y pulsa <strong>Enviar</strong>.
    </div>
    <button class="btn btn-green" onclick="enviarWhatsApp()">üí¨ Enviar por WhatsApp</button>
    <button class="btn btn-gray" onclick="repetir()">üîÑ Repetir grabaci√≥n</button>
  </div>

  <!-- PASO 6: √âXITO -->
  <div class="step" id="step-exito">
    <div class="success-icon">üéâ</div>
    <h2 style="text-align:center">¬°Listo!</h2>
    <p class="sub" style="text-align:center; margin-bottom:20px">Adjunta el v√≠deo descargado en WhatsApp y pulsa <strong>Enviar</strong>.</p>
    <button class="btn btn-green" onclick="reiniciar()">‚ûï Grabar otro v√≠deo</button>
  </div>

</div>

<script>
  const WHATSAPP_NUMERO = "34606664908";

  let mediaRecorder = null;
  let chunks = [];
  let videoBlob = null;
  let stream = null;
  let formatoData = null;

  function showStep(id) {
    document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");
  }

  function limpiarTexto(t) {
    return (t || "").replace(/[\/\\:*?"<>|]/g, "_").replace(/\s+/g, "_");
  }

  window.onload = () => {
    const params = new URLSearchParams(window.location.search);
    const proyecto = params.get("proyecto") || "";
    const formato = params.get("formato") || "";
    const ot = params.get("ot") || "";
    formatoData = { proyecto, formato, ot };
    document.getElementById("info-proyecto").textContent = ot ? ot + " ‚Äì " + proyecto : proyecto || "Sin proyecto";
    document.getElementById("info-formato").textContent = formato || "Sin formato";
  };

  function irAHorizontal() {
    showStep("step-horizontal");
  }

  function iniciarCuentaAtras() {
    showStep("step-countdown");
    let cuenta = 3;
    const el = document.getElementById("countdown-num");

    function tick() {
      el.style.animation = "none";
      el.offsetHeight; // reflow para reiniciar animaci√≥n
      el.style.animation = "pulse-num 1s ease-in-out";

      if (cuenta === 0) {
        irAGrabar();
        return;
      }
      el.textContent = cuenta;
      cuenta--;
      setTimeout(tick, 1000);
    }
    tick();
  }

  async function irAGrabar() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "environment",
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: true
      });
      document.getElementById("video-live").srcObject = stream;

      chunks = [];
      const tipo = MediaRecorder.isTypeSupported("video/mp4") ? "video/mp4" : "video/webm";
      mediaRecorder = new MediaRecorder(stream, { mimeType: tipo });
      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
      mediaRecorder.onstop = procesarVideo;
      mediaRecorder.start();

      showStep("step-grabar");
    } catch (e) {
      document.getElementById("info-error").innerHTML = '<div class="error">‚ùå No se pudo acceder a la c√°mara. Comprueba los permisos.</div>';
      showStep("step-info");
    }
  }

  function pararGrabacion() {
    if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
    if (stream) stream.getTracks().forEach(t => t.stop());
  }

  function cancelarGrabacion() {
    pararGrabacion();
    showStep("step-info");
  }

  function procesarVideo() {
    const tipo = chunks[0]?.type || "video/webm";
    videoBlob = new Blob(chunks, { type: tipo });
    document.getElementById("video-replay").src = URL.createObjectURL(videoBlob);
    const fecha = new Date().toISOString().split("T")[0];
    const titulo = [limpiarTexto(formatoData.ot), limpiarTexto(formatoData.proyecto), limpiarTexto(formatoData.formato), fecha].filter(Boolean).join("_");
    document.getElementById("titulo").value = titulo;
    showStep("step-confirmar");
  }

  function repetir() { videoBlob = null; chunks = []; showStep("step-info"); }

  function enviarWhatsApp() {
    const titulo = document.getElementById("titulo").value.trim() || "video";
    const proyecto = formatoData.ot ? formatoData.ot + " ‚Äì " + formatoData.proyecto : formatoData.proyecto || "Sin proyecto";
    const mensaje = "üé¨ *Nuevo v√≠deo de producci√≥n*\n\nüìÅ Proyecto: " + proyecto + "\nüìã Formato: " + (formatoData.formato || "Sin formato") + "\nüè∑Ô∏è T√≠tulo: " + titulo + "\nüìÖ Fecha: " + new Date().toLocaleDateString("es-ES");

    const a = document.createElement("a");
    a.href = URL.createObjectURL(videoBlob);
    a.download = titulo + ".mp4";
    a.click();

    setTimeout(() => {
      window.open("https://wa.me/" + WHATSAPP_NUMERO + "?text=" + encodeURIComponent(mensaje), "_blank");
      showStep("step-exito");
    }, 800);
  }

  function reiniciar() { videoBlob = null; chunks = []; showStep("step-info"); }
</script>
</body>
</html>
